# Job Workflow Testing Guide

This document outlines the testing strategy for each job workflow generated by Pipecraft.

## üìã Job Workflow Overview

### 1. Changes Workflow (`job.changes.yml`)
**Purpose**: Detects which domains have changed between branches
**Key Features**:
- Uses `dorny/paths-filter@v3` to detect changes
- Supports multi-branch flow (develop ‚Üí test ‚Üí staging ‚Üí main)
- Outputs boolean flags for each domain
- Forces full deployment on main/staging/test branches

**Test Scenarios**:
- Different branch references (main, develop, staging, test)
- Path filtering for each domain
- Branch flow logic validation
- Output generation for all domains

### 2. Version Workflow (`job.version.yml`)
**Purpose**: Calculates semantic version based on conventional commits
**Key Features**:
- Analyzes commits since last tag
- Determines version bump type (major/minor/patch)
- Supports conventional commit format
- Outputs current, next, and version type

**Test Scenarios**:
- Different base references (main, develop, staging)
- Various commit types (feat, fix, breaking)
- Version calculation logic
- Output validation

### 3. Tag Workflow (`job.tag.yml`)
**Purpose**: Creates and pushes Git tags for releases
**Key Features**:
- Validates version format (v1.2.3)
- Checks for existing tags
- Creates annotated tags with messages
- Pushes tags to remote repository

**Test Scenarios**:
- Valid version formats (v1.0.0, v1.2.3, v2.0.0)
- Invalid version formats
- Existing tag detection
- Tag creation and pushing

### 4. CreatePR Workflow (`job.createpr.yml`)
**Purpose**: Creates pull requests between branches
**Key Features**:
- Checks for existing PRs
- Creates PRs with title, body, and labels
- Supports different branch combinations
- Returns PR number and URL

**Test Scenarios**:
- Different branch combinations (develop‚Üímain, feature‚Üídevelop)
- PR title and body validation
- Label assignment
- Existing PR detection

### 5. Branch Workflow (`job.branch.yml`)
**Purpose**: Manages branch operations (fast-forward, create, delete)
**Key Features**:
- Fast-forward merging
- Branch creation from source
- Branch deletion (local and remote)
- Input validation for each action

**Test Scenarios**:
- Fast-forward operations
- Branch creation
- Branch deletion
- Input validation
- Error handling

### 6. Apps Workflow (`job.apps.yml`)
**Purpose**: Deploys applications to different environments
**Key Features**:
- Environment-specific configuration
- Multi-domain deployment
- Version management
- Deployment status tracking

**Test Scenarios**:
- Different environments (development, staging, production)
- Various domain combinations
- Version handling
- Deployment status validation

## üß™ Testing Strategy

### Unit Testing
Each workflow is tested in isolation with:
- Mock inputs and environment variables
- Validation of workflow syntax
- Step-by-step execution verification
- Output validation

### Integration Testing
Workflows are tested with:
- Real GitHub Actions environment simulation
- Cross-workflow dependencies
- End-to-end scenarios
- Error handling and recovery

### End-to-End Testing
Complete workflows are tested with:
- Real repository scenarios
- Multiple workflow combinations
- Performance testing
- User experience validation

## üîß Test Configuration

### Environment Setup
```bash
# Required environment variables
export GITHUB_ACTIONS=true
export GITHUB_WORKFLOW=test-workflow
export GITHUB_RUN_ID=123456789
export GITHUB_RUN_NUMBER=1
export GITHUB_ACTOR=test-user
export GITHUB_REPOSITORY=test-org/test-repo
export GITHUB_EVENT_NAME=push
export GITHUB_SHA=abc123def456
export GITHUB_REF=refs/heads/main
export GITHUB_HEAD_REF=""
export GITHUB_BASE_REF=""
export GITHUB_WORKSPACE=/path/to/project
export GITHUB_TOKEN=test-token
```

### Test Data
```bash
# Test configurations
export TEST_DOMAINS="api,web,libs"
export TEST_BRANCHES="main,develop,staging"
export TEST_VERSIONS="v1.0.0,v1.2.3,v2.0.0"
export TEST_ENVIRONMENTS="development,staging,production"
```

## üìä Test Results

### Success Criteria
- ‚úÖ Workflow syntax validation
- ‚úÖ Step execution without errors
- ‚úÖ Output generation
- ‚úÖ Error handling
- ‚úÖ Performance within limits

### Failure Scenarios
- ‚ùå Syntax errors
- ‚ùå Missing inputs
- ‚ùå Invalid configurations
- ‚ùå Timeout errors
- ‚ùå Permission issues

## üöÄ Running Tests

### Individual Workflow Tests
```bash
# Test specific workflow
./tests/github-local/test-job-workflows.sh -w job.changes.yml

# Test with verbose output
./tests/github-local/test-job-workflows.sh -w job.version.yml -v

# Test with debug mode
./tests/github-local/test-job-workflows.sh -w job.tag.yml -d
```

### All Workflow Tests
```bash
# Test all workflows
./tests/github-local/test-job-workflows.sh

# Test with verbose output
./tests/github-local/test-job-workflows.sh -v

# Test with debug mode
./tests/github-local/test-job-workflows.sh -d
```

## üîç Debugging

### Common Issues
1. **Workflow syntax errors**: Check YAML formatting
2. **Missing inputs**: Verify all required inputs are provided
3. **Permission issues**: Check GitHub token permissions
4. **Environment variables**: Verify all required env vars are set
5. **Docker issues**: Ensure Docker is running

### Debug Commands
```bash
# List available workflows
act --list

# Show workflow details
act -W .github/workflows/job.changes.yml --list

# Run with verbose output
act -W .github/workflows/job.changes.yml --verbose

# Run with debug output
act -W .github/workflows/job.changes.yml --debug
```

## üìà Performance Testing

### Metrics
- **Execution time**: Track workflow execution time
- **Resource usage**: Monitor CPU and memory usage
- **Step duration**: Measure individual step performance
- **Error rates**: Track failure rates and patterns

### Benchmarks
- Changes workflow: < 30 seconds
- Version workflow: < 20 seconds
- Tag workflow: < 15 seconds
- CreatePR workflow: < 25 seconds
- Branch workflow: < 20 seconds
- Apps workflow: < 60 seconds

## üîÑ Continuous Integration

### GitHub Actions Integration
```yaml
name: Job Workflow Tests
on: [push, pull_request]
jobs:
  test-job-workflows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Act
        run: curl https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
      - name: Run Job Workflow Tests
        run: ./tests/github-local/test-job-workflows.sh
```

### Local Development
```bash
# Watch mode for development
./tests/github-local/test-job-workflows.sh --watch

# Run specific test suite
./tests/github-local/test-job-workflows.sh --suite changes

# Run with coverage
./tests/github-local/test-job-workflows.sh --coverage
```

## üìö Best Practices

### Test Organization
1. **Group related tests**: Organize tests by workflow type
2. **Use fixtures**: Create reusable test data
3. **Mock external services**: Avoid external dependencies
4. **Test edge cases**: Include error scenarios and edge cases

### Performance
1. **Parallel execution**: Run independent tests in parallel
2. **Resource management**: Monitor Docker resource usage
3. **Cleanup**: Clean up test artifacts after runs
4. **Caching**: Use Docker layer caching for faster builds

### Maintenance
1. **Regular updates**: Keep Act and test dependencies updated
2. **Documentation**: Document test scenarios and expected outcomes
3. **Monitoring**: Track test performance and reliability
4. **Feedback**: Collect feedback from test results

## üÜò Troubleshooting

### Common Problems
```bash
# Act not found
export PATH=$PATH:/usr/local/bin

# Docker permission denied
sudo usermod -aG docker $USER

# Workflow syntax errors
act -W .github/workflows/job.changes.yml --dry-run --verbose

# Environment variable issues
act -W .github/workflows/job.changes.yml --env-file .env
```

### Getting Help
- [Act Documentation](https://github.com/nektos/act)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Docker Documentation](https://docs.docker.com/)
- [Project Issues](https://github.com/your-org/pipecraft/issues)
