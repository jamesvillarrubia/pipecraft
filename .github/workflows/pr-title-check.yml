name: "PR Title Format Check"

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened

permissions:
  pull-requests: write
  contents: read

jobs:
  main:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        id: lint_pr_title
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Configure which types are allowed (newline-delimited).
          # Default: https://github.com/commitizen/conventional-commit-types
          types: |
            fix
            feat
            docs
            style
            chore
            refactor
            perf
            test
            ci
            build
            revert
            major
          requireScope: false

      # Check for breaking changes
      - name: Check for breaking changes
        id: breaking_check
        if: always()
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Check if title starts with types that bump major version or contains "!" or "BREAKING"
          # Types that bump major: breaking
          MAJOR_TYPES_PATTERN="^(breaking):"
          if [[ "$PR_TITLE" =~ $MAJOR_TYPES_PATTERN ]] || [[ "$PR_TITLE" =~ ^[a-z]+!: ]] || [[ "$PR_TITLE" =~ BREAKING ]] || [[ "$PR_TITLE" =~ breaking ]]; then
            echo "is_breaking=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Breaking change detected in PR title"
          elif [[ "$PR_BODY" =~ BREAKING[[:space:]]CHANGE ]]; then
            echo "is_breaking=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Breaking change detected in PR body"
          else
            echo "is_breaking=false" >> $GITHUB_OUTPUT
          fi

      - uses: marocchino/sticky-pull-request-comment@v2
        # When the previous steps fails, the workflow would stop. By adding this
        # condition you can continue the execution with the populated error message.
        if: always() && (steps.lint_pr_title.outputs.error_message != null)
        with:
          header: pr-title-lint-error
          message: |
            Hey there and thank you for opening this pull request! üëãüèº

            We require pull request titles to follow the [Conventional Commits specification](https://www.conventionalcommits.org/en/v1.0.0/) and it looks like your proposed title needs to be adjusted.

            Details:

            ```
            ${{ steps.lint_pr_title.outputs.error_message }}
            ```

      # Delete a previous comment when the issue has been resolved
      - if: ${{ steps.lint_pr_title.outputs.error_message == null }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-title-lint-error
          delete: true

      # Add warning comment for breaking changes
      - name: Add breaking change warning
        if: always() && steps.breaking_check.outputs.is_breaking == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: breaking-change-warning
          message: |
            ## ‚ö†Ô∏è  BREAKING CHANGE DETECTED

            This PR contains a **BREAKING CHANGE** which will result in a **MAJOR version bump**.

            **Important considerations:**
            - Breaking changes require careful review by maintainers
            - This will increment the major version (e.g., 1.x.x ‚Üí 2.0.0)
            - Users will need to update their code when upgrading
            - Documentation should be updated to reflect the breaking changes
            - Consider if this change can be made backwards-compatible

            **Required actions:**
            - [ ] Breaking changes are documented in the PR description
            - [ ] Migration guide is provided (if applicable)
            - [ ] All maintainers have been notified for review

            **Reviewers:** This PR requires additional scrutiny due to the breaking change.

      # Delete breaking change warning when resolved
      - name: Remove breaking change warning
        if: always() && steps.breaking_check.outputs.is_breaking == 'false'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: breaking-change-warning
          delete: true