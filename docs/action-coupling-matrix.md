# Action Coupling Matrix

> **Last Updated**: 2025-11-01
> **Purpose**: Baseline assessment of all PipeCraft actions to track decoupling progress

This document provides a comprehensive assessment of each GitHub Action generated by PipeCraft, analyzing their dependencies, coupling points, and marketplace readiness.

---

## Summary Dashboard

| Action                                  | Config Reading | Strategy Dependent | Package Manager | Marketplace Ready | Complexity | Priority     |
| --------------------------------------- | -------------- | ------------------ | --------------- | ----------------- | ---------- | ------------ |
| [detect-changes](#detect-changes)       | ✅ Via Input   | ✅ Multi-Strategy  | ✅ Auto-detect  | ✅ **READY**      | Medium     | HIGH         |
| [create-tag](#create-tag)               | ❌ None        | ✅ Agnostic        | ✅ N/A          | ✅ **READY**      | Low        | HIGH         |
| [calculate-version](#calculate-version) | ⚠️ Implicit    | ⚠️ Unknown         | ⚠️ npm only?    | ❌ Needs Review   | Medium     | HIGH         |
| [promote-branch](#promote-branch)       | ❌ Yes (jq)    | ✅ Agnostic        | ✅ N/A          | ❌ Needs Decouple | Medium     | **CRITICAL** |
| [manage-branch](#manage-branch)         | ❓ Unknown     | ❓ Unknown         | ❓ Unknown      | ❌ Needs Audit    | Low        | MEDIUM       |
| [create-pr](#create-pr)                 | ❓ Unknown     | ✅ Likely Agnostic | ✅ N/A          | ❌ Needs Audit    | Low        | MEDIUM       |
| [create-release](#create-release)       | ❓ Unknown     | ✅ Likely Agnostic | ✅ N/A          | ❌ Needs Audit    | Low        | MEDIUM       |
| [run-nx-affected](#run-nx-affected)     | ❌ None        | ❌ Nx-specific     | ⚠️ Needs Check  | ⚠️ Nx-only OK     | Medium     | LOW          |

**Legend**:

- ✅ = Good state / No issues
- ⚠️ = Needs improvement
- ❌ = Blocking issue / Must fix
- ❓ = Needs investigation

---

## Detailed Action Analysis

### detect-changes

**Status**: ✅ **MARKETPLACE READY** - Best practice example

**Location**: [`actions/detect-changes/action.yml`](../actions/detect-changes/action.yml)

**Template**: [`src/templates/actions/detect-changes.yml.tpl.ts`](../src/templates/actions/detect-changes.yml.tpl.ts)

#### Configuration Dependencies

- ✅ **No direct config file reading**
- ✅ Accepts `domains-config` as YAML string input
- ✅ Workflow passes config at runtime

#### Strategy Support

- ✅ **Multi-strategy in single file**:
  - Nx dependency graph analysis (primary)
  - Path-based change detection (fallback)
- ✅ Auto-detects Nx availability (`nx.json`, `package.json`)
- ✅ Graceful fallback via conditional steps
- ✅ Accepts `useNx` input to control strategy

#### Package Manager Handling

- ✅ **Auto-detection from lockfiles**:
  ```bash
  if [ -f "pnpm-lock.yaml" ]; then corepack enable; pnpm install
  elif [ -f "yarn.lock" ]; then yarn install
  elif [ -f "package-lock.json" ]; then npm ci
  else npm install
  fi
  ```
- ✅ No hardcoded package manager
- ✅ Works with npm, yarn, pnpm seamlessly

#### Marketplace Readiness Score: **5/5**

- ✅ Config-agnostic (accepts inputs)
- ✅ Strategy-agnostic (multi-strategy support)
- ✅ Package-manager-agnostic (auto-detect)
- ✅ Well-documented
- ✅ Comprehensive outputs

#### Regeneration Triggers

- ❌ **Currently**: Domain changes require regeneration (domains embedded in workflow)
- ✅ **Future**: With runtime config, NO regeneration needed

#### Key Strengths

- **Template for all other actions** - demonstrates best practices
- Conditional steps pattern: `if: steps.nx-check.outputs.available == 'true' && inputs.useNx == 'true'`
- Unified output format regardless of strategy
- Excellent error handling and logging

#### Recommended Actions

1. Publish to marketplace immediately (PR #2)
2. Use as reference for refactoring other actions

---

### create-tag

**Status**: ✅ **MARKETPLACE READY** - Simple and clean

**Location**: [`actions/create-tag/action.yml`](../actions/create-tag/action.yml)

**Template**: [`src/templates/actions/create-tag.yml.tpl.ts`](../src/templates/actions/create-tag.yml.tpl.ts)

#### Configuration Dependencies

- ✅ **No config file reading**
- ✅ All inputs passed explicitly
- ✅ Pure git operations

#### Strategy Support

- ✅ **Strategy-agnostic** - Git operations only
- ✅ No dependencies on Nx/turbo/monorepo structure

#### Package Manager Handling

- ✅ **N/A** - No package manager operations

#### Marketplace Readiness Score: **5/5**

- ✅ Zero config dependencies
- ✅ Simple, focused purpose
- ✅ Well-defined inputs/outputs
- ✅ Works in any git repository
- ✅ Easy to test

#### Regeneration Triggers

- ✅ None - This action never needs regeneration

#### Key Strengths

- Simplest action in the suite
- Clear single responsibility
- No external dependencies beyond git
- Perfect candidate for early marketplace publication

#### Recommended Actions

1. Publish to marketplace (PR #3)
2. Good "quick win" to validate publishing process

---

### calculate-version

**Status**: ⚠️ **NEEDS REVIEW** - Unclear dependencies

**Location**: [`actions/calculate-version/action.yml`](../actions/calculate-version/action.yml)

**Template**: [`src/templates/actions/calculate-version.yml.tpl.ts`](../src/templates/actions/calculate-version.yml.tpl.ts)

#### Configuration Dependencies

- ⚠️ **Implicit dependency on `.release-it.cjs`**
- ❓ Need to verify if reads other config files
- ⚠️ Creates temporary `package.json` - why?

#### Strategy Support

- ❓ **Unknown** - Need to check if Nx/monorepo aware
- ❓ Does it handle monorepo versions differently?

#### Package Manager Handling

- ❌ **Hardcoded to npm** (from analysis):
  ```bash
  npm install @release-it/conventional-changelog
  ```
- ❌ Ignores `packageManager` config
- ⚠️ Won't work in pnpm/yarn-only environments

#### Marketplace Readiness Score: **2/5**

- ⚠️ Implicit config dependencies
- ⚠️ Package manager hardcoding
- ❓ Strategy support unclear
- ✅ Focused purpose
- ✅ Clear outputs

#### Regeneration Triggers

- ❓ Unknown - need to verify when regeneration required

#### Identified Issues

1. npm hardcoding (low priority - GitHub runners include npm)
2. Implicit `.release-it.cjs` dependency
3. Unclear if strategy-agnostic

#### Recommended Actions

1. **PR #6**: Audit action thoroughly
2. **PR #7**: Decouple and make strategy-agnostic
3. Consider: Accept version bump rules as input instead of reading config
4. Low priority: Add package manager auto-detection (if needed)

---

### promote-branch

**Status**: ❌ **NEEDS DECOUPLING** - Actively reads config

**Location**: [`actions/promote-branch/action.yml`](../actions/promote-branch/action.yml)

**Template**: [`src/templates/actions/promote-branch.yml.tpl.ts`](../src/templates/actions/promote-branch.yml.tpl.ts)

#### Configuration Dependencies

- ❌ **Directly reads `.pipecraftrc`**
- ❌ Uses `jq` to parse `branchFlow`
- ❌ Reads `autoMerge` setting from config
- ⚠️ Format-dependent (expects JSON via jq)

#### Strategy Support

- ✅ **Strategy-agnostic** - Git operations only
- ✅ No dependencies on Nx/turbo

#### Package Manager Handling

- ✅ **N/A** - No package manager operations

#### Marketplace Readiness Score: **2/5**

- ❌ Config file reading (blocking issue)
- ❌ Format-dependent (jq = JSON only)
- ✅ Git operations are clean
- ✅ Purpose is clear
- ⚠️ PipeCraft-specific currently

#### Regeneration Triggers

- ❌ **Branch flow changes** - Action reads branchFlow from config
- ❌ **autoMerge setting changes** - Read from config

#### Identified Issues

1. **Critical**: Reads `.pipecraftrc` directly
2. **Critical**: Uses jq (JSON-only), breaks with YAML config
3. **Medium**: Calculates target branch instead of accepting input
4. **Recent fix** (commit `370c94f`): Removed some config parsing, but not all

#### Recommended Actions

1. **PR #4 (CRITICAL)**: Complete decoupling
   - Add `targetBranch` input
   - Add `autoMerge` input
   - Add `mergeMethod` input
   - Remove ALL config file reading
   - Remove jq dependency
2. **PR #5**: Publish to marketplace after decoupling

#### Refactoring Plan

**Current**:

```yaml
steps:
  - name: Read Config
    run: |
      BRANCH_FLOW=$(cat "$CONFIG_PATH" | jq -r '.branchFlow | join(" ")')
      AUTO_MERGE=$(cat "$CONFIG_PATH" | jq -r '.autoMerge')
```

**Target**:

```yaml
inputs:
  targetBranch:
    description: 'Target branch to promote to'
    required: true
  autoMerge:
    description: 'Whether to auto-merge'
    required: false
    default: 'false'
steps:
  # Direct git operations, no config reading
```

**Workflow responsibility** (generator):

```yaml
jobs:
  read-config:
    outputs:
      targetBranch: ${{ steps.calc.outputs.targetBranch }}
  promote:
    needs: read-config
    steps:
      - uses: pipecraft/promote-branch@v1
        with:
          target-branch: ${{ needs.read-config.outputs.targetBranch }}
```

---

### manage-branch

**Status**: ❓ **NEEDS AUDIT** - Unknown coupling

**Location**: [`actions/manage-branch/action.yml`](../actions/manage-branch/action.yml)

**Template**: [`src/templates/actions/manage-branch.yml.tpl.ts`](../src/templates/actions/manage-branch.yml.tpl.ts)

#### Configuration Dependencies

- ❓ **Unknown** - Need to review action code
- ❓ Check for hidden `.pipecraftrc` reading

#### Strategy Support

- ❓ **Unknown** - Likely strategy-agnostic (git ops)

#### Package Manager Handling

- ❓ **Unknown** - Likely N/A

#### Marketplace Readiness Score: **?/5**

- ❓ Need full audit

#### Recommended Actions

1. **PR #6**: Full audit of this action
2. **PR #9**: Decouple if needed, then publish

---

### create-pr

**Status**: ❓ **NEEDS AUDIT** - Likely close to ready

**Location**: [`actions/create-pr/action.yml`](../actions/create-pr/action.yml)

**Template**: [`src/templates/actions/create-pr.yml.tpl.ts`](../src/templates/actions/create-pr.yml.tpl.ts)

#### Configuration Dependencies

- ❓ **Unknown** - Need to verify
- Likely uses GitHub CLI (`gh`) only

#### Strategy Support

- ✅ **Likely strategy-agnostic** - GitHub API operations

#### Package Manager Handling

- ✅ **N/A** - No package operations

#### Marketplace Readiness Score: **?/5**

- Likely **4/5** if no config dependencies

#### Recommended Actions

1. **PR #6**: Audit
2. **PR #10**: Light touch-up and publish

---

### create-release

**Status**: ❓ **NEEDS AUDIT** - Likely close to ready

**Location**: [`actions/create-release/action.yml`](../actions/create-release/action.yml)

**Template**: [`src/templates/actions/create-release.yml.tpl.ts`](../src/templates/actions/create-release.yml.tpl.ts)

#### Configuration Dependencies

- ❓ **Unknown** - Need to verify
- Likely uses GitHub CLI (`gh`) only

#### Strategy Support

- ✅ **Likely strategy-agnostic** - GitHub API operations

#### Package Manager Handling

- ✅ **N/A** - No package operations

#### Marketplace Readiness Score: **?/5**

- Likely **4/5** if no config dependencies

#### Recommended Actions

1. **PR #6**: Audit
2. **PR #11**: Light touch-up and publish

---

### run-nx-affected

**Status**: ⚠️ **NX-SPECIFIC** - By design

**Location**: [`actions/run-nx-affected/action.yml`](../actions/run-nx-affected/action.yml)
(Note: Only generated when Nx detected)

**Template**: [`src/templates/actions/run-nx-affected.yml.tpl.ts`](../src/templates/actions/run-nx-affected.yml.tpl.ts)

#### Configuration Dependencies

- ❓ **Unknown** - Need to verify
- Likely minimal (Nx handles config)

#### Strategy Support

- ❌ **Nx-specific by design** - This is intentional
- ✅ That's okay! - Nx users need this
- ✅ Marketplace can have specialized actions

#### Package Manager Handling

- ❓ **Unknown** - Need to check if auto-detects
- ⚠️ Should support npm/yarn/pnpm for Nx

#### Marketplace Readiness Score: **3/5**

- ✅ Clear Nx-specific purpose
- ✅ Useful for Nx community
- ⚠️ Need to verify package manager handling
- ⚠️ Need to verify config independence
- ✅ Well-defined scope

#### Recommended Actions

1. **PR #6**: Audit package manager handling
2. Ensure auto-detects pnpm/yarn/npm
3. Publish as `@pipecraft/run-nx-affected` (Nx users will find it)
4. Document Nx requirement clearly

---

## Cross-Cutting Concerns

### Config File Format Coupling

**Current State**:

- `.pipecraftrc` migrated from JSON → YAML (recent)
- Some actions still use `jq` (JSON parser)
- Format coupling causes fragility

**Actions Affected**:

- ❌ `promote-branch` - Uses jq (JSON-only)
- ❓ Others unknown

**Solution**:

- Actions should NOT read config files
- Workflow reads config (can handle any format)
- Actions accept inputs only

### Package Manager Detection

**Current State**:

- `detect-changes` demonstrates best practice ✅
- Other actions may hardcode npm ❌

**Best Practice Pattern** (from detect-changes):

```bash
if [ -f "pnpm-lock.yaml" ]; then
  corepack enable && pnpm install
elif [ -f "yarn.lock" ]; then
  yarn install
elif [ -f "package-lock.json" ]; then
  npm ci || npm install
else
  npm install
fi
```

**Actions to Review**:

- `calculate-version` - Known npm hardcoding
- `run-nx-affected` - Unknown
- Others likely N/A (no package operations)

### Strategy Detection Pattern

**Best Practice** (from detect-changes):

```yaml
- name: Check for Nx
  id: nx-check
  run: |
    if [ -f "nx.json" ]; then
      echo "available=true" >> $GITHUB_OUTPUT
    else
      echo "available=false" >> $GITHUB_OUTPUT
    fi

- name: Use Nx Strategy
  if: steps.nx-check.outputs.available == 'true' && inputs.useNx == 'true'
  run: # Nx-specific logic

- name: Fallback Strategy
  if: steps.nx-check.outputs.available != 'true' || inputs.useNx != 'true'
  run: # Path-based logic
```

**Key Elements**:

1. Auto-detection step
2. Input override capability (`useNx`)
3. Conditional steps based on strategy
4. Graceful fallback
5. Unified output format

---

## Decoupling Priority Matrix

### Critical (Start Immediately)

1. **promote-branch** - Actively reads config, blocks marketplace

### High (Next Sprint)

2. **calculate-version** - Unclear dependencies, critical functionality
3. **detect-changes** - Publish immediately (already ready) ✅
4. **create-tag** - Publish immediately (already ready) ✅

### Medium (Following Sprint)

5. **manage-branch** - Audit first
6. **create-pr** - Audit first
7. **create-release** - Audit first

### Low (Nice to Have)

8. **run-nx-affected** - Nx-specific okay, verify package manager

---

## Marketplace Readiness Roadmap

### Wave 1: Quick Wins (Week 1-2)

- ✅ `detect-changes` - Publish immediately
- ✅ `create-tag` - Publish immediately

### Wave 2: After Decoupling (Week 3-4)

- ⚠️ `promote-branch` - Decouple first, then publish

### Wave 3: After Audit (Week 5-7)

- ❓ `calculate-version` - Audit → decouple → publish
- ❓ `manage-branch` - Audit → fix if needed → publish
- ❓ `create-pr` - Audit → fix if needed → publish
- ❓ `create-release` - Audit → fix if needed → publish

### Wave 4: Specialized (Week 8+)

- ⚠️ `run-nx-affected` - Verify → publish (Nx-specific okay)

---

## Success Metrics

### Per Action

- [ ] Config file reading: None (✅) or via input only
- [ ] Strategy support: Agnostic or clearly specialized
- [ ] Package manager: Auto-detect or N/A
- [ ] Marketplace published: Version 1.0.0+
- [ ] Documentation: Comprehensive README
- [ ] Tests: Standalone test suite
- [ ] CI/CD: Automated releases

### Overall Suite

- [ ] 7+ actions published
- [ ] All decoupled from PipeCraft config
- [ ] All independently versioned
- [ ] Complete marketplace documentation
- [ ] Integration tests with PipeCraft generator

---

## Next Steps

1. ✅ **This document complete** - Baseline established
2. **PR #2**: Publish `detect-changes` to marketplace
3. **PR #3**: Publish `create-tag` to marketplace
4. **PR #4**: Decouple `promote-branch`
5. **PR #6**: Audit remaining actions (calculate-version, manage-branch, create-pr, create-release, run-nx-affected)
6. Continue with incremental PRs per plan

---

## Document Maintenance

This document should be updated:

- ✅ After each action is audited (fill in ❓ unknowns)
- ✅ After each action is refactored (update status)
- ✅ After each action is published (update marketplace status)
- ✅ When new actions are added
- ✅ When patterns or best practices change

**Review Frequency**: After each PR that affects actions
